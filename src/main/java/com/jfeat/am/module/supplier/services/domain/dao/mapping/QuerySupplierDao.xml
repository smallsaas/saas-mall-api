<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jfeat.am.module.supplier.services.domain.dao.QuerySupplierDao">
    <sql id="Base_Column_List">
        t_supplier
        .
        id
        , t_supplier.name, t_supplier.note, t_supplier.type, t_supplier.url, t_supplier.address, t_supplier.org_id AS orgId
        , t_supplier.phone as phone
        , t_supplier.user_id as userId
        , t_supplier.end_user_id as endUserId
        , t_supplier.link as link
        , t_supplier.snapshot as snapshot
        , t_supplier.bind_key as bindKey
        , t_supplier.bind_type as bindType
        , t_supplier.bind_user_id as bindUserId
        , t_supplier.vr_id as vrId
    </sql>

    <sql id="QueryOwnedOrgIds">
        SELECT children.id
        FROM t_sys_org,
             t_sys_org as children
        WHERE t_sys_org.left_num &lt;= children.left_num
          AND t_sys_org.right_num >= children.left_num
          and t_sys_org.id = #{record.orgId}
        order by t_sys_org.node_level ASC
    </sql>


    <select id="queryMasterModel" resultType="SupplierModel">
        SELECT t_supplier.*
        FROM t_supplier
        WHERE t_supplier.id = #{id}
        GROUP BY t_supplier.id
    </select>


    <select id="findSupplierPage" resultType="SupplierRecord" parameterType="SupplierRecord">
        SELECT
        <include refid="Base_Column_List"/>
        ,t_sys_user.account as 'account'
        ,t_end_user.`name` as 'endUserName'
        ,count( t_order.id ) as orderCount
        , product.productCount as productCount
        FROM t_supplier left join t_sys_user on t_sys_user.id = t_supplier.user_id
        left join t_end_user on t_end_user.id = t_supplier.end_user_id

        LEFT JOIN t_order ON t_order.org_id = t_supplier.org_id and t_order.status = 'CONFIRMED_DELIVER_PENDING'

        LEFT JOIN (
            SELECT
            t_supplier.id AS chiId,
            count( t_product.id ) AS productCount
            FROM
            t_supplier
            LEFT JOIN t_product ON t_product.org_id = t_supplier.org_id
                    and t_product.`status` ='ONSELL'
            GROUP BY
            t_supplier.id
        ) AS product ON product.chiId = t_supplier.id

        <if test="record.orgId > 0">
            ,(<include refid="QueryOwnedOrgIds"></include>) AS ownedOrgIds
        </if>

        WHERE 1=1
        <if test="record.orgId > 0">
            AND t_supplier.org_id = ownedOrgIds.id
        </if>

        <if test="record.phone != null and record.phone != ''">
            AND t_supplier.phone LIKE CONCAT('%',#{record.phone},'%')
        </if>


        <if test="record.id != null and record.id>0 ">
            AND t_supplier.id LIKE CONCAT('%',#{record.id},'%')
        </if>
        <if test="record.name != null and record.name!= ''">
            AND t_supplier.name LIKE CONCAT('%',#{record.name},'%')
        </if>
        <if test="record.note != null and record.note!= ''">
            AND t_supplier.note LIKE CONCAT('%',#{record.note},'%')
        </if>
        <if test="record.type != null and record.type>0 ">
            AND t_supplier.type LIKE CONCAT('%',#{record.type},'%')
        </if>
        <if test="record.url != null and record.url!= ''">
            AND t_supplier.url LIKE CONCAT('%',#{record.url},'%')
        </if>
        <if test="record.address != null and record.address!= ''">
            AND t_supplier.address LIKE CONCAT('%',#{record.address},'%')
        </if>


        <if test="record.orgId != null and record.orgId>0 ">
            AND t_supplier.org_id IN (<include refid="QueryOwnedOrgIds"/>)
        </if>

        <if test="startTime != null">
            <![CDATA[AND t_supplier.start_time >= DATE(#{startTime})]]>
        </if>
        <if test="endTime != null">
            <![CDATA[AND t_supplier.end_time <= DATE(#{endTime}]]>
        </if>
        <if test="search != null and search != ''">
            AND
             ( t_supplier.name LIKE CONCAT('%',#{search},'%')
                or  t_supplier.phone LIKE CONCAT('%',#{search},'%')
                or t_sys_user.account LIKE CONCAT('%',#{search},'%') )
        </if>

        GROUP BY
        t_supplier.id
    </select>

<!--    查询所有供应商-->
    <select id="queryAllSupplier" resultType="SupplierRecord">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_supplier
    </select>


    <select id="querySupplierByEndUserId"  resultType="SupplierRecord">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_supplier
        left join t_end_user on t_end_user.phone = t_supplier.phone
        where t_end_user.id = #{endUserId}
    </select>
</mapper>