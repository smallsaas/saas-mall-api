<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jfeat.am.module.order.services.domain.dao.QueryOrderDao">
    <sql id="Base_Column_List">
        t_order.id, t_order.user_id AS userId, t_order.order_number AS orderNumber, t_order.trade_number AS tradeNumber,
        t_order.payment_type AS paymentType, t_order.created_date AS createdDate, t_order.pay_date AS payDate,
        t_order.confirm_date AS confirmDate, t_order.deliver_date AS deliverDate, t_order.delivered_date AS
        deliveredDate, t_order.deal_date AS dealDate, t_order.deliver_order_number AS deliverOrderNumber,
        t_order.status, t_order.total_price AS totalPrice, t_order.freight, t_order.description, t_order.remark,
        t_order.invoice, t_order.invoice_title AS invoiceTitle, t_order.receiving_time AS receivingTime, t_order.zip,
        t_order.contact_user AS contactUser, t_order.phone, t_order.province, t_order.city, t_order.district,
        t_order.street, t_order.detail, t_order.cover, t_order.express_number AS expressNumber, t_order.express_company
        AS expressCompany, t_order.express_code AS expressCode, t_order.settled, t_order.previous_status AS
        previousStatus, t_order.is_deliver_reminder AS isDeliverReminder, t_order.is_deleted AS isDeleted,
        t_order.point_exchange_rate AS pointExchangeRate, t_order.coupon_info AS couponInfo, t_order.marketing,
        t_order.marketing_id AS marketingId, t_order.marketing_description AS marketingDescription, t_order.mid,
        t_order.mname, t_order.store_id AS storeId, t_order.store_name AS storeName, t_order.store_user_id AS
        storeUserId, t_order.store_user_name AS storeUserName, t_order.type, t_order.pay_credit AS payCredit,
        t_order.delivery_type AS deliveryType, t_order.origin, t_order.store_user_code AS storeUserCode,
        t_order.store_code AS storeCode, t_order.store_cover AS storeCover, t_order.store_guide_user_id AS
        storeGuideUserId, t_order.store_guide_user_code AS storeGuideUserCode, t_order.store_guide_user_name AS
        storeGuideUserName, t_order.inviter_user_id AS inviterUserId, t_order.inviter_user_name AS inviterUserName,
        t_order.followed_store_id AS followedStoreId, t_order.followed_store_code AS followedStoreCode,
        t_order.followed_store_name AS followedStoreName, t_order.followed_store_cover AS followedStoreCover,
        t_order.comment_id AS commentId, t_order.binding_store_id AS bindingStoreId, t_order.binding_store_code AS
        bindingStoreCode, t_order.binding_store_name AS bindingStoreName, t_order.binding_store_cover AS
        bindingStoreCover, t_order.refund_fee AS refundFee, t_order.store_address AS storeAddress,
        t_order.supplementary_fee AS supplementaryFee, t_order.origin_price AS originPrice, t_order.coupon_price AS
        couponPrice, t_order.credit_price AS creditPrice, t_order.ext_coupon_id AS extCouponId, t_order.ext_user_type AS
        extUserType, t_order.ext_coupon_type AS extCouponType, t_order.ext_discount AS extDiscount, t_order.ext_cuts AS
        extCuts,t_order.org_id AS orgId
    </sql>

    <sql id="QueryOwnedOrgIds">
        SELECT children.id FROM t_sys_org, t_sys_org as children WHERE t_sys_org.left_num &lt;= children.left_num AND
            t_sys_org.right_num >= children.left_num and t_sys_org.id=#{record.orgId} order by t_sys_org.node_level ASC
    </sql>

    <select id="findOrderPage" resultType="OrderRecord" parameterType="OrderRecord">
        SELECT
        <include refid="Base_Column_List"/>
        ,t_end_user.name as userName
        ,settlement_status as settlementStatus
        ,t_end_user.avatar as avatar
        ,t_end_user.phone as userPhone
        FROM t_order
        left join t_end_user on t_order.user_id=t_end_user.id

        <if test="record.orgId > 0">
            ,(<include refid="QueryOwnedOrgIds"></include>) AS ownedOrgIds
        </if>

        WHERE 1=1
        <if test="record.orgId > 0">
            AND t_order.org_id = ownedOrgIds.id
        </if>

        <if test="record.pName != null and record.pName!= '' ">
            and t_order.id in (select t_order.id
            from t_order join t_order_item on t_order_item.order_id= t_order.id
            and t_order_item.product_name like CONCAT('%',#{record.pName},'%')
            )
        </if>
        <if test="record.barcode != null and record.barcode!= '' ">
            and t_order.id in (select t_order.id
            from t_order join t_order_item on t_order_item.order_id= t_order.id
            and t_order_item.barcode like CONCAT('%',#{record.barcode},'%')
            )
        </if>


        <if test="ew != null and ew.sqlSegment != null and ew.sqlSegment != ''">
            AND ${ew.sqlSegment}
        </if>

        <if test="record.id != null and record.id>0 ">
            AND t_order.id LIKE CONCAT('%',#{record.id},'%')
        </if>
        <if test="record.userId != null and record.userId>0 ">
            AND t_order.user_id = #{record.userId}
        </if>
        <if test="record.orderNumber != null and record.orderNumber!= ''">
            AND t_order.order_number LIKE CONCAT('%',#{record.orderNumber},'%')
        </if>
        <if test="record.tradeNumber != null and record.tradeNumber!= ''">
            AND t_order.trade_number LIKE CONCAT('%',#{record.tradeNumber},'%')
        </if>
        <if test="record.paymentType != null and record.paymentType!= ''">
            AND t_order.payment_type LIKE CONCAT('%',#{record.paymentType},'%')
        </if>
        <if test="record.createdDate != null and record.createdDate>0 ">
            AND t_order.created_date LIKE CONCAT('%',#{record.createdDate},'%')
        </if>
        <if test="record.payDate != null and record.payDate>0 ">
            AND t_order.pay_date LIKE CONCAT('%',#{record.payDate},'%')
        </if>
        <if test="record.confirmDate != null and record.confirmDate>0 ">
            AND t_order.confirm_date LIKE CONCAT('%',#{record.confirmDate},'%')
        </if>
        <if test="record.deliverDate != null and record.deliverDate>0 ">
            AND t_order.deliver_date LIKE CONCAT('%',#{record.deliverDate},'%')
        </if>
        <if test="record.deliveredDate != null and record.deliveredDate>0 ">
            AND t_order.delivered_date LIKE CONCAT('%',#{record.deliveredDate},'%')
        </if>
        <if test="record.dealDate != null and record.dealDate>0 ">
            AND t_order.deal_date LIKE CONCAT('%',#{record.dealDate},'%')
        </if>
        <if test="record.deliverOrderNumber != null and record.deliverOrderNumber!= ''">
            AND t_order.deliver_order_number LIKE CONCAT('%',#{record.deliverOrderNumber},'%')
        </if>
        <if test="record.status != null and record.status!= ''">
            AND t_order.status = #{record.status}
        </if>
        <if test="record.totalPrice != null and record.totalPrice>0 ">
            AND t_order.total_price LIKE CONCAT('%',#{record.totalPrice},'%')
        </if>
        <if test="record.freight != null and record.freight>0 ">
            AND t_order.freight LIKE CONCAT('%',#{record.freight},'%')
        </if>
        <if test="record.description != null and record.description!= ''">
            AND t_order.description LIKE CONCAT('%',#{record.description},'%')
        </if>
        <if test="record.remark != null and record.remark!= ''">
            AND t_order.remark LIKE CONCAT('%',#{record.remark},'%')
        </if>
        <if test="record.invoice != null and record.invoice>0 ">
            AND t_order.invoice LIKE CONCAT('%',#{record.invoice},'%')
        </if>
        <if test="record.invoiceTitle != null and record.invoiceTitle!= ''">
            AND t_order.invoice_title LIKE CONCAT('%',#{record.invoiceTitle},'%')
        </if>
        <if test="record.receivingTime != null and record.receivingTime!= ''">
            AND t_order.receiving_time LIKE CONCAT('%',#{record.receivingTime},'%')
        </if>
        <if test="record.zip != null and record.zip!= ''">
            AND t_order.zip LIKE CONCAT('%',#{record.zip},'%')
        </if>
        <if test="record.contactUser != null and record.contactUser!= ''">
            AND t_order.contact_user LIKE CONCAT('%',#{record.contactUser},'%')
        </if>
        <if test="record.phone != null and record.phone!= ''">
            AND t_order.phone LIKE CONCAT('%',#{record.phone},'%')
        </if>
        <if test="record.province != null and record.province!= ''">
            AND t_order.province LIKE CONCAT('%',#{record.province},'%')
        </if>
        <if test="record.city != null and record.city!= ''">
            AND t_order.city LIKE CONCAT('%',#{record.city},'%')
        </if>
        <if test="record.district != null and record.district!= ''">
            AND t_order.district LIKE CONCAT('%',#{record.district},'%')
        </if>
        <if test="record.street != null and record.street!= ''">
            AND t_order.street LIKE CONCAT('%',#{record.street},'%')
        </if>
        <if test="record.detail != null and record.detail!= ''">
            AND t_order.detail LIKE CONCAT('%',#{record.detail},'%')
        </if>
        <if test="record.cover != null and record.cover!= ''">
            AND t_order.cover LIKE CONCAT('%',#{record.cover},'%')
        </if>
        <if test="record.expressNumber != null and record.expressNumber!= ''">
            AND t_order.express_number LIKE CONCAT('%',#{record.expressNumber},'%')
        </if>
        <if test="record.expressCompany != null and record.expressCompany!= ''">
            AND t_order.express_company LIKE CONCAT('%',#{record.expressCompany},'%')
        </if>
        <if test="record.expressCode != null and record.expressCode!= ''">
            AND t_order.express_code LIKE CONCAT('%',#{record.expressCode},'%')
        </if>
        <if test="record.settled != null and record.settled>0 ">
            AND t_order.settled LIKE CONCAT('%',#{record.settled},'%')
        </if>
        <if test="record.previousStatus != null and record.previousStatus!= ''">
            AND t_order.previous_status LIKE CONCAT('%',#{record.previousStatus},'%')
        </if>
        <if test="record.isDeliverReminder != null and record.isDeliverReminder>0 ">
            AND t_order.is_deliver_reminder LIKE CONCAT('%',#{record.isDeliverReminder},'%')
        </if>
        <if test="record.isDeleted != null and record.isDeleted>0 ">
            AND t_order.is_deleted LIKE CONCAT('%',#{record.isDeleted},'%')
        </if>
        <if test="record.pointExchangeRate != null and record.pointExchangeRate>0 ">
            AND t_order.point_exchange_rate LIKE CONCAT('%',#{record.pointExchangeRate},'%')
        </if>
        <if test="record.couponInfo != null and record.couponInfo!= ''">
            AND t_order.coupon_info LIKE CONCAT('%',#{record.couponInfo},'%')
        </if>
        <if test="record.marketing != null and record.marketing!= ''">
            AND t_order.marketing LIKE CONCAT('%',#{record.marketing},'%')
        </if>
        <if test="record.marketingId != null and record.marketingId>0 ">
            AND t_order.marketing_id LIKE CONCAT('%',#{record.marketingId},'%')
        </if>
        <if test="record.marketingDescription != null and record.marketingDescription!= ''">
            AND t_order.marketing_description LIKE CONCAT('%',#{record.marketingDescription},'%')
        </if>
        <if test="record.mid != null and record.mid>0 ">
            AND t_order.mid LIKE CONCAT('%',#{record.mid},'%')
        </if>
        <if test="record.mname != null and record.mname!= ''">
            AND t_order.mname LIKE CONCAT('%',#{record.mname},'%')
        </if>
        <if test="record.storeId != null and record.storeId!= ''">
            AND t_order.store_id LIKE CONCAT('%',#{record.storeId},'%')
        </if>
        <if test="record.storeName != null and record.storeName!= ''">
            AND t_order.store_name LIKE CONCAT('%',#{record.storeName},'%')
        </if>
        <if test="record.storeUserId != null and record.storeUserId!= ''">
            AND t_order.store_user_id LIKE CONCAT('%',#{record.storeUserId},'%')
        </if>
        <if test="record.storeUserName != null and record.storeUserName!= ''">
            AND t_order.store_user_name LIKE CONCAT('%',#{record.storeUserName},'%')
        </if>
        <if test="record.type != null and record.type!= ''">
            AND t_order.type = #{record.type}
        </if>
        <if test="record.payCredit != null and record.payCredit>0 ">
            AND t_order.pay_credit LIKE CONCAT('%',#{record.payCredit},'%')
        </if>
        <if test="record.deliveryType != null and record.deliveryType!= ''">
            AND t_order.delivery_type LIKE CONCAT('%',#{record.deliveryType},'%')
        </if>
        <if test="record.origin != null and record.origin!= ''">
            AND t_order.origin LIKE CONCAT('%',#{record.origin},'%')
        </if>
        <if test="record.storeUserCode != null and record.storeUserCode!= ''">
            AND t_order.store_user_code LIKE CONCAT('%',#{record.storeUserCode},'%')
        </if>
        <if test="record.storeCode != null and record.storeCode!= ''">
            AND t_order.store_code LIKE CONCAT('%',#{record.storeCode},'%')
        </if>
        <if test="record.storeCover != null and record.storeCover!= ''">
            AND t_order.store_cover LIKE CONCAT('%',#{record.storeCover},'%')
        </if>
        <if test="record.storeGuideUserId != null and record.storeGuideUserId!= ''">
            AND t_order.store_guide_user_id LIKE CONCAT('%',#{record.storeGuideUserId},'%')
        </if>
        <if test="record.storeGuideUserCode != null and record.storeGuideUserCode!= ''">
            AND t_order.store_guide_user_code LIKE CONCAT('%',#{record.storeGuideUserCode},'%')
        </if>
        <if test="record.storeGuideUserName != null and record.storeGuideUserName!= ''">
            AND t_order.store_guide_user_name LIKE CONCAT('%',#{record.storeGuideUserName},'%')
        </if>
        <if test="record.inviterUserId != null and record.inviterUserId!= ''">
            AND t_order.inviter_user_id LIKE CONCAT('%',#{record.inviterUserId},'%')
        </if>
        <if test="record.inviterUserName != null and record.inviterUserName!= ''">
            AND t_order.inviter_user_name LIKE CONCAT('%',#{record.inviterUserName},'%')
        </if>
        <if test="record.followedStoreId != null and record.followedStoreId!= ''">
            AND t_order.followed_store_id LIKE CONCAT('%',#{record.followedStoreId},'%')
        </if>
        <if test="record.followedStoreCode != null and record.followedStoreCode!= ''">
            AND t_order.followed_store_code LIKE CONCAT('%',#{record.followedStoreCode},'%')
        </if>
        <if test="record.followedStoreName != null and record.followedStoreName!= ''">
            AND t_order.followed_store_name LIKE CONCAT('%',#{record.followedStoreName},'%')
        </if>
        <if test="record.followedStoreCover != null and record.followedStoreCover!= ''">
            AND t_order.followed_store_cover LIKE CONCAT('%',#{record.followedStoreCover},'%')
        </if>
        <if test="record.commentId != null and record.commentId!= ''">
            AND t_order.comment_id LIKE CONCAT('%',#{record.commentId},'%')
        </if>
        <if test="record.bindingStoreId != null and record.bindingStoreId!= ''">
            AND t_order.binding_store_id LIKE CONCAT('%',#{record.bindingStoreId},'%')
        </if>
        <if test="record.bindingStoreCode != null and record.bindingStoreCode!= ''">
            AND t_order.binding_store_code LIKE CONCAT('%',#{record.bindingStoreCode},'%')
        </if>
        <if test="record.bindingStoreName != null and record.bindingStoreName!= ''">
            AND t_order.binding_store_name LIKE CONCAT('%',#{record.bindingStoreName},'%')
        </if>
        <if test="record.bindingStoreCover != null and record.bindingStoreCover!= ''">
            AND t_order.binding_store_cover LIKE CONCAT('%',#{record.bindingStoreCover},'%')
        </if>
        <if test="record.refundFee != null and record.refundFee>0 ">
            AND t_order.refund_fee LIKE CONCAT('%',#{record.refundFee},'%')
        </if>
        <if test="record.storeAddress != null and record.storeAddress!= ''">
            AND t_order.store_address LIKE CONCAT('%',#{record.storeAddress},'%')
        </if>
        <if test="record.supplementaryFee != null and record.supplementaryFee>0 ">
            AND t_order.supplementary_fee LIKE CONCAT('%',#{record.supplementaryFee},'%')
        </if>
        <if test="record.originPrice != null and record.originPrice>0 ">
            AND t_order.origin_price LIKE CONCAT('%',#{record.originPrice},'%')
        </if>
        <if test="record.couponPrice != null and record.couponPrice>0 ">
            AND t_order.coupon_price LIKE CONCAT('%',#{record.couponPrice},'%')
        </if>
        <if test="record.creditPrice != null and record.creditPrice>0 ">
            AND t_order.credit_price LIKE CONCAT('%',#{record.creditPrice},'%')
        </if>
        <if test="record.extCouponId != null and record.extCouponId!= ''">
            AND t_order.ext_coupon_id LIKE CONCAT('%',#{record.extCouponId},'%')
        </if>
        <if test="record.extUserType != null and record.extUserType!= ''">
            AND t_order.ext_user_type LIKE CONCAT('%',#{record.extUserType},'%')
        </if>
        <if test="record.extCouponType != null and record.extCouponType!= ''">
            AND t_order.ext_coupon_type LIKE CONCAT('%',#{record.extCouponType},'%')
        </if>
        <if test="record.extDiscount != null and record.extDiscount>0 ">
            AND t_order.ext_discount LIKE CONCAT('%',#{record.extDiscount},'%')
        </if>
        <if test="record.extCuts != null and record.extCuts>0 ">
            AND t_order.ext_cuts LIKE CONCAT('%',#{record.extCuts},'%')
        </if>
<!--        <if test="record.orgId != null ">
            AND t_order.org_id = #{record.orgId}
        </if>-->
        <if test="startTime != null">
            <![CDATA[AND t_order.created_date >= DATE(#{startTime})]]>
        </if>
        <if test="startEndTime != null">
            <![CDATA[AND t_order.created_date < DATE_ADD(DATE(#{startEndTime}),INTERVAL 1 DAY)]]>
        </if>
        <if test="endTime != null">
            <![CDATA[AND t_order.created_date < DATE_ADD(DATE(#{endTime}),INTERVAL 1 DAY)]]>
        </if>


        <if test="leftMoney != null ">
            AND t_order.total_price  >= #{leftMoney}
        </if>
        <if test="rightMoney!= null">
            AND t_order.total_price  &lt;= #{rightMoney}
        </if>

        <if test="search != null and search != ''">
            AND
            (
            t_order.order_number LIKE CONCAT('%',#{search},'%')
            or t_order.id in (select t_order.id
            from t_order join t_order_item on t_order_item.order_id= t_order.id
            and t_order_item.product_name like CONCAT('%',#{search},'%')
            )
            or t_order.id in (select t_order.id
            from t_order join t_order_item on t_order_item.order_id= t_order.id
            and t_order_item.barcode like CONCAT('%',#{search},'%')
            )
            or t_order.contact_user LIKE CONCAT('%',#{search},'%')
            or t_user.`name` LIKE CONCAT('%', #{search}, '%')
            or t_user.real_name LIKE CONCAT('%',#{search}, '%')
            )
        </if>

        order by created_date desc

    </select>


    <select id="settlementOrder" resultType="OrderRecord" parameterType="OrderRecord">
        SELECT
        <include refid="Base_Column_List"/>
        ,sum(amount.orderAmount) as orderAmount,chi.alliance_name as allianceName,
        (case when t_user.real_name is NULL  then t_user.`name`
        else t_user.real_name end )as userName
        ,settlement_status as settlementStatus
        FROM t_order
        left join t_user on t_order.user_id=t_user.id
        left join t_alliance on t_alliance.user_id=t_user.id
        left join t_alliance chi on chi.id=t_alliance.invitor_alliance_id

        left join (
            select ifnull(sum(ROUND(item.price*item.quantity,2)),0) as orderAmount,
            o.user_id,
            o.created_date as a_created_date
            from t_order_item item
            inner join t_order o on item.order_id=o.id and o.status='CLOSED_CONFIRMED'

            LEFT JOIN t_user u on u.id=o.user_id
            GROUP BY o.id
        )
        as amount on amount.user_id = chi.user_id
        and month(amount.a_created_date) = month(t_order.created_date) and year(amount.a_created_date) = year(t_order.created_date)
        WHERE 1=1
        <if test="record.pName != null and record.pName!= '' ">
            and t_order.id in (select t_order.id
            from t_order join t_order_item on t_order_item.order_id= t_order.id
            and t_order_item.product_name like CONCAT('%',#{record.pName},'%')
            )
        </if>
        <if test="record.barcode != null and record.barcode!= '' ">
            and t_order.id in (select t_order.id
            from t_order join t_order_item on t_order_item.order_id= t_order.id
            and t_order_item.barcode like CONCAT('%',#{record.barcode},'%')
            )
        </if>

        <if test="record.id != null and record.id>0 ">
            AND t_order.id LIKE CONCAT('%',#{record.id},'%')
        </if>
        <if test="record.userId != null and record.userId>0 ">
            AND t_order.user_id = #{record.userId}
        </if>
        <if test="record.orderNumber != null and record.orderNumber!= ''">
            AND t_order.order_number LIKE CONCAT('%',#{record.orderNumber},'%')
        </if>
        <if test="record.tradeNumber != null and record.tradeNumber!= ''">
            AND t_order.trade_number LIKE CONCAT('%',#{record.tradeNumber},'%')
        </if>
        <if test="record.paymentType != null and record.paymentType!= ''">
            AND t_order.payment_type LIKE CONCAT('%',#{record.paymentType},'%')
        </if>
        <if test="record.createdDate != null and record.createdDate>0 ">
            AND t_order.created_date LIKE CONCAT('%',#{record.createdDate},'%')
        </if>
        <if test="record.payDate != null and record.payDate>0 ">
            AND t_order.pay_date LIKE CONCAT('%',#{record.payDate},'%')
        </if>
        <if test="record.confirmDate != null and record.confirmDate>0 ">
            AND t_order.confirm_date LIKE CONCAT('%',#{record.confirmDate},'%')
        </if>
        <if test="record.deliverDate != null and record.deliverDate>0 ">
            AND t_order.deliver_date LIKE CONCAT('%',#{record.deliverDate},'%')
        </if>
        <if test="record.deliveredDate != null and record.deliveredDate>0 ">
            AND t_order.delivered_date LIKE CONCAT('%',#{record.deliveredDate},'%')
        </if>
        <if test="record.dealDate != null and record.dealDate>0 ">
            AND t_order.deal_date LIKE CONCAT('%',#{record.dealDate},'%')
        </if>
        <if test="record.deliverOrderNumber != null and record.deliverOrderNumber!= ''">
            AND t_order.deliver_order_number LIKE CONCAT('%',#{record.deliverOrderNumber},'%')
        </if>
        <if test="record.status != null and record.status!= ''">
            AND t_order.status = #{record.status}
        </if>
        <if test="record.totalPrice != null and record.totalPrice>0 ">
            AND t_order.total_price LIKE CONCAT('%',#{record.totalPrice},'%')
        </if>
        <if test="record.freight != null and record.freight>0 ">
            AND t_order.freight LIKE CONCAT('%',#{record.freight},'%')
        </if>
        <if test="record.description != null and record.description!= ''">
            AND t_order.description LIKE CONCAT('%',#{record.description},'%')
        </if>
        <if test="record.remark != null and record.remark!= ''">
            AND t_order.remark LIKE CONCAT('%',#{record.remark},'%')
        </if>
        <if test="record.invoice != null and record.invoice>0 ">
            AND t_order.invoice LIKE CONCAT('%',#{record.invoice},'%')
        </if>
        <if test="record.invoiceTitle != null and record.invoiceTitle!= ''">
            AND t_order.invoice_title LIKE CONCAT('%',#{record.invoiceTitle},'%')
        </if>
        <if test="record.receivingTime != null and record.receivingTime!= ''">
            AND t_order.receiving_time LIKE CONCAT('%',#{record.receivingTime},'%')
        </if>
        <if test="record.zip != null and record.zip!= ''">
            AND t_order.zip LIKE CONCAT('%',#{record.zip},'%')
        </if>
        <if test="record.contactUser != null and record.contactUser!= ''">
            AND t_order.contact_user LIKE CONCAT('%',#{record.contactUser},'%')
        </if>
        <if test="record.phone != null and record.phone!= ''">
            AND t_order.phone LIKE CONCAT('%',#{record.phone},'%')
        </if>
        <if test="record.province != null and record.province!= ''">
            AND t_order.province LIKE CONCAT('%',#{record.province},'%')
        </if>
        <if test="record.city != null and record.city!= ''">
            AND t_order.city LIKE CONCAT('%',#{record.city},'%')
        </if>
        <if test="record.district != null and record.district!= ''">
            AND t_order.district LIKE CONCAT('%',#{record.district},'%')
        </if>
        <if test="record.street != null and record.street!= ''">
            AND t_order.street LIKE CONCAT('%',#{record.street},'%')
        </if>
        <if test="record.detail != null and record.detail!= ''">
            AND t_order.detail LIKE CONCAT('%',#{record.detail},'%')
        </if>
        <if test="record.cover != null and record.cover!= ''">
            AND t_order.cover LIKE CONCAT('%',#{record.cover},'%')
        </if>
        <if test="record.expressNumber != null and record.expressNumber!= ''">
            AND t_order.express_number LIKE CONCAT('%',#{record.expressNumber},'%')
        </if>
        <if test="record.expressCompany != null and record.expressCompany!= ''">
            AND t_order.express_company LIKE CONCAT('%',#{record.expressCompany},'%')
        </if>
        <if test="record.expressCode != null and record.expressCode!= ''">
            AND t_order.express_code LIKE CONCAT('%',#{record.expressCode},'%')
        </if>
        <if test="record.settled != null and record.settled>0 ">
            AND t_order.settled LIKE CONCAT('%',#{record.settled},'%')
        </if>
        <if test="record.previousStatus != null and record.previousStatus!= ''">
            AND t_order.previous_status LIKE CONCAT('%',#{record.previousStatus},'%')
        </if>
        <if test="record.isDeliverReminder != null and record.isDeliverReminder>0 ">
            AND t_order.is_deliver_reminder LIKE CONCAT('%',#{record.isDeliverReminder},'%')
        </if>
        <if test="record.isDeleted != null and record.isDeleted>0 ">
            AND t_order.is_deleted LIKE CONCAT('%',#{record.isDeleted},'%')
        </if>
        <if test="record.pointExchangeRate != null and record.pointExchangeRate>0 ">
            AND t_order.point_exchange_rate LIKE CONCAT('%',#{record.pointExchangeRate},'%')
        </if>
        <if test="record.couponInfo != null and record.couponInfo!= ''">
            AND t_order.coupon_info LIKE CONCAT('%',#{record.couponInfo},'%')
        </if>
        <if test="record.marketing != null and record.marketing!= ''">
            AND t_order.marketing LIKE CONCAT('%',#{record.marketing},'%')
        </if>
        <if test="record.marketingId != null and record.marketingId>0 ">
            AND t_order.marketing_id LIKE CONCAT('%',#{record.marketingId},'%')
        </if>
        <if test="record.marketingDescription != null and record.marketingDescription!= ''">
            AND t_order.marketing_description LIKE CONCAT('%',#{record.marketingDescription},'%')
        </if>
        <if test="record.mid != null and record.mid>0 ">
            AND t_order.mid LIKE CONCAT('%',#{record.mid},'%')
        </if>
        <if test="record.mname != null and record.mname!= ''">
            AND t_order.mname LIKE CONCAT('%',#{record.mname},'%')
        </if>
        <if test="record.storeId != null and record.storeId!= ''">
            AND t_order.store_id LIKE CONCAT('%',#{record.storeId},'%')
        </if>
        <if test="record.storeName != null and record.storeName!= ''">
            AND t_order.store_name LIKE CONCAT('%',#{record.storeName},'%')
        </if>
        <if test="record.storeUserId != null and record.storeUserId!= ''">
            AND t_order.store_user_id LIKE CONCAT('%',#{record.storeUserId},'%')
        </if>
        <if test="record.storeUserName != null and record.storeUserName!= ''">
            AND t_order.store_user_name LIKE CONCAT('%',#{record.storeUserName},'%')
        </if>
        <if test="record.type != null and record.type!= ''">
            AND t_order.type = #{record.type}
        </if>
        <if test="record.payCredit != null and record.payCredit>0 ">
            AND t_order.pay_credit LIKE CONCAT('%',#{record.payCredit},'%')
        </if>
        <if test="record.deliveryType != null and record.deliveryType!= ''">
            AND t_order.delivery_type LIKE CONCAT('%',#{record.deliveryType},'%')
        </if>
        <if test="record.origin != null and record.origin!= ''">
            AND t_order.origin LIKE CONCAT('%',#{record.origin},'%')
        </if>
        <if test="record.storeUserCode != null and record.storeUserCode!= ''">
            AND t_order.store_user_code LIKE CONCAT('%',#{record.storeUserCode},'%')
        </if>
        <if test="record.storeCode != null and record.storeCode!= ''">
            AND t_order.store_code LIKE CONCAT('%',#{record.storeCode},'%')
        </if>
        <if test="record.storeCover != null and record.storeCover!= ''">
            AND t_order.store_cover LIKE CONCAT('%',#{record.storeCover},'%')
        </if>
        <if test="record.storeGuideUserId != null and record.storeGuideUserId!= ''">
            AND t_order.store_guide_user_id LIKE CONCAT('%',#{record.storeGuideUserId},'%')
        </if>
        <if test="record.storeGuideUserCode != null and record.storeGuideUserCode!= ''">
            AND t_order.store_guide_user_code LIKE CONCAT('%',#{record.storeGuideUserCode},'%')
        </if>
        <if test="record.storeGuideUserName != null and record.storeGuideUserName!= ''">
            AND t_order.store_guide_user_name LIKE CONCAT('%',#{record.storeGuideUserName},'%')
        </if>
        <if test="record.inviterUserId != null and record.inviterUserId!= ''">
            AND t_order.inviter_user_id LIKE CONCAT('%',#{record.inviterUserId},'%')
        </if>
        <if test="record.inviterUserName != null and record.inviterUserName!= ''">
            AND t_order.inviter_user_name LIKE CONCAT('%',#{record.inviterUserName},'%')
        </if>
        <if test="record.followedStoreId != null and record.followedStoreId!= ''">
            AND t_order.followed_store_id LIKE CONCAT('%',#{record.followedStoreId},'%')
        </if>
        <if test="record.followedStoreCode != null and record.followedStoreCode!= ''">
            AND t_order.followed_store_code LIKE CONCAT('%',#{record.followedStoreCode},'%')
        </if>
        <if test="record.followedStoreName != null and record.followedStoreName!= ''">
            AND t_order.followed_store_name LIKE CONCAT('%',#{record.followedStoreName},'%')
        </if>
        <if test="record.followedStoreCover != null and record.followedStoreCover!= ''">
            AND t_order.followed_store_cover LIKE CONCAT('%',#{record.followedStoreCover},'%')
        </if>
        <if test="record.commentId != null and record.commentId!= ''">
            AND t_order.comment_id LIKE CONCAT('%',#{record.commentId},'%')
        </if>
        <if test="record.bindingStoreId != null and record.bindingStoreId!= ''">
            AND t_order.binding_store_id LIKE CONCAT('%',#{record.bindingStoreId},'%')
        </if>
        <if test="record.bindingStoreCode != null and record.bindingStoreCode!= ''">
            AND t_order.binding_store_code LIKE CONCAT('%',#{record.bindingStoreCode},'%')
        </if>
        <if test="record.bindingStoreName != null and record.bindingStoreName!= ''">
            AND t_order.binding_store_name LIKE CONCAT('%',#{record.bindingStoreName},'%')
        </if>
        <if test="record.bindingStoreCover != null and record.bindingStoreCover!= ''">
            AND t_order.binding_store_cover LIKE CONCAT('%',#{record.bindingStoreCover},'%')
        </if>
        <if test="record.refundFee != null and record.refundFee>0 ">
            AND t_order.refund_fee LIKE CONCAT('%',#{record.refundFee},'%')
        </if>
        <if test="record.storeAddress != null and record.storeAddress!= ''">
            AND t_order.store_address LIKE CONCAT('%',#{record.storeAddress},'%')
        </if>
        <if test="record.supplementaryFee != null and record.supplementaryFee>0 ">
            AND t_order.supplementary_fee LIKE CONCAT('%',#{record.supplementaryFee},'%')
        </if>
        <if test="record.originPrice != null and record.originPrice>0 ">
            AND t_order.origin_price LIKE CONCAT('%',#{record.originPrice},'%')
        </if>
        <if test="record.couponPrice != null and record.couponPrice>0 ">
            AND t_order.coupon_price LIKE CONCAT('%',#{record.couponPrice},'%')
        </if>
        <if test="record.creditPrice != null and record.creditPrice>0 ">
            AND t_order.credit_price LIKE CONCAT('%',#{record.creditPrice},'%')
        </if>
        <if test="record.extCouponId != null and record.extCouponId!= ''">
            AND t_order.ext_coupon_id LIKE CONCAT('%',#{record.extCouponId},'%')
        </if>
        <if test="record.extUserType != null and record.extUserType!= ''">
            AND t_order.ext_user_type LIKE CONCAT('%',#{record.extUserType},'%')
        </if>
        <if test="record.extCouponType != null and record.extCouponType!= ''">
            AND t_order.ext_coupon_type LIKE CONCAT('%',#{record.extCouponType},'%')
        </if>
        <if test="record.extDiscount != null and record.extDiscount>0 ">
            AND t_order.ext_discount LIKE CONCAT('%',#{record.extDiscount},'%')
        </if>
        <if test="record.extCuts != null and record.extCuts>0 ">
            AND t_order.ext_cuts LIKE CONCAT('%',#{record.extCuts},'%')
        </if>
        <if test="record.settlementStatus != null ">
            AND t_order.settlement_status LIKE CONCAT('%',#{record.settlementStatus},'%')
        </if>
        <if test="record.orgId != null ">
            AND t_order.org_id = #{record.orgId}
        </if>

        <if test="leftMoney != null ">
            AND t_order.total_price  >= #{leftMoney}
        </if>
        <if test="rightMoney!= null">
            AND t_order.total_price  &lt;= #{rightMoney}
        </if>


        <if test="startTime != null">
            <![CDATA[AND t_order.created_date >= DATE(#{startTime})]]>
        </if>
        <if test="startEndTime != null">
            <![CDATA[AND t_order.created_date < DATE_ADD(DATE(#{startEndTime}),INTERVAL 1 DAY)]]>
        </if>
        <if test="endTime != null">
            <![CDATA[AND t_order.created_date <= DATE_ADD(DATE(#{endTime}),INTERVAL 1 DAY)]]>
        </if>

        <if test="allianceId != null and allianceId!= ''">
            AND t_alliance.id LIKE CONCAT('%',#{allianceId},'%')
        </if>

        <if test="userName != null and userName != ''">
        AND(
            t_user.name like CONCAT('%',#{userName},'%')
            or
            t_user.real_name like CONCAT('%',#{userName},'%')
            )
         </if>

        <if test="search != null and search != ''">
            AND
            (
            t_order.order_number LIKE CONCAT('%',#{search},'%')
            or t_order.id in (select t_order.id
            from t_order join t_order_item on t_order_item.order_id= t_order.id
            and t_order_item.product_name like CONCAT('%',#{search},'%')
            )

            or t_order.id in (select t_order.id
            from t_order join t_order_item on t_order_item.order_id= t_order.id
            and t_order_item.barcode like CONCAT('%',#{search},'%')
            )

            )
        </if>
        GROUP BY t_order.id
        order by created_date desc

    </select>



    <select id="refundOrderPage" resultType="OrderRecord">
        SELECT
        <include refid="Base_Column_List"/>
        ,t_user.name as userName
        FROM t_order
        left join t_user on t_order.user_id=t_user.id
        WHERE 1=1
        <choose>
            <when test="status!= null and status=='CLOSED_REFUNDED'">
                AND t_order.status = 'CLOSED_REFUNDED'
            </when>
            <when test="status!= null and status=='CANCELED_REFUND_PENDING'">
                AND t_order.status = 'CANCELED_REFUND_PENDING'
            </when>
            <when test="status!= null and status=='CANCELED_RETURN_PENDING'">
                AND t_order.status = 'CANCELED_RETURN_PENDING'
            </when>
            <otherwise>and (
                t_order.status = 'CLOSED_REFUNDED'
                or t_order.status = 'CANCELED_REFUND_PENDING'
                or t_order.status = 'CANCELED_RETURN_PENDING')
            </otherwise>
        </choose>

        <if test="startTime != null">
            <![CDATA[AND t_order.created_date >= DATE(#{startTime})]]>
        </if>
        <if test="endTime != null">
            <![CDATA[AND t_order.created_date < DATE_ADD(DATE(#{endTime}),INTERVAL 1 DAY)]]>
        </if>

        <if test="search != null and search != ''">
            AND
            (
            t_order.order_number LIKE CONCAT('%',#{search},'%')
            or t_order.id in (select t_order.id
            from t_order join t_order_item on t_order_item.order_id= t_order.id
            and t_order_item.product_name like CONCAT('%',#{search},'%')
            )
            or t_order.id in (select t_order.id
            from t_order join t_order_item on t_order_item.order_id= t_order.id
            and t_order_item.barcode like CONCAT('%',#{search},'%')
            )
            or t_order.contact_user LIKE CONCAT('%',#{search},'%')
            or t_user.`name` LIKE CONCAT('%', #{search}, '%')
            or t_user.real_name LIKE CONCAT('%',#{search}, '%')
            )
        </if>
        order by created_date desc
    </select>


    <select id="selectUserId" parameterType="java.lang.String" resultType="java.lang.Long">
        select id from t_sys_user where name=#{name}
    </select>

    <select id="selectProductId" parameterType="java.lang.String" resultType="java.lang.String">
        select id from t_front_product where bar_code=#{barCode}
    </select>


    <select id="getUserName"  resultType="java.lang.String">
        select name as userName
        FROM t_user
        where t_user.id =#{userId}
    </select>

    <insert id="insertOrderItem" parameterType="java.util.Map">
        insert into t_order_item (order_id,barcode,product_name,quantity,final_price) value
        (#{orderId},#{barcode},#{productName},#{quantity},#{finalPrice})
    </insert>



    <select id="getAllianceOrder"  resultType="OrderRecord">
        SELECT *,
        (case when u.real_name is NULL  then u.`name`
        else u.real_name end )as userName
        FROM t_order o
        LEFT JOIN t_user u on u.id=o.user_id
        LEFT JOIN t_alliance a on a.id=#{id}
        LEFT JOIN t_alliance kid on kid.invitor_alliance_id=a.id

        WHERE ( o.user_id=a.user_id OR o.user_id=kid.user_id)

        AND o.created_date>STR_TO_DATE((SELECT value FROM t_config_field WHERE field='starting_time'),'%Y-%m-%d')
        AND o.created_date&lt;DATE_ADD(STR_TO_DATE((SELECT value FROM t_config_field WHERE field='starting_time'),'%Y-%m-%d') , interval (SELECT value FROM t_config_field WHERE field='settlement_cycle') MONTH)

        <if test="startTime != null">
            <![CDATA[AND o.created_date >= DATE(#{startTime})]]>
        </if>
        <if test="endTime != null">
            <![CDATA[AND o.created_date < DATE_ADD(DATE(#{endTime}),INTERVAL 1 DAY)]]>
        </if>
        <if test="status != null and status!= ''">
            AND o.status = #{status}
        </if>

        <if test="search != null and search != ''">
            AND
            (
            o.order_number LIKE CONCAT('%',#{search},'%')
            or o.contact_user LIKE CONCAT('%',#{search},'%')
            or u.`name` LIKE CONCAT('%', #{search}, '%')
            or u.real_name LIKE CONCAT('%',#{search}, '%')
            )
        </if>
        ORDER BY o.created_date desc


    </select>

    <select id="getUsers"  resultType="com.jfeat.am.module.frontuser.services.gen.persistence.model.FrontUser">
        select id,`name`,real_name as realName from t_user
        <if test="search != null and search != ''">
            where (t_user.name LIKE CONCAT('%',#{search},'%')
            or t_user.real_name LIKE CONCAT('%',#{search},'%')
            )
        </if>
    </select>


    <select id="getProducts"  resultType="com.jfeat.am.module.frontproduct.services.domain.model.FrontProductRecord">
        select id,`name`,t_product.barcode,t_product.price from t_product
        where t_product.`status`= 'ONSELL'
        <if test="search != null and search != ''">
            AND t_product.name LIKE CONCAT('%',#{search},'%')
        </if>
    </select>

    <select id="selectByUserId"  resultType="com.jfeat.am.module.frontuser.services.gen.persistence.model.FrontUser">
    select id,`name` from t_user where id=#{id}
    </select>

    <insert id="insertOrderItem" parameterType="java.util.Map">
        insert into t_order_item (order_id,barcode,product_name,quantity,final_price
                       ,price,cost_price,cover,product_id) value
         (#{orderId},#{barcode},#{productName},#{quantity},#{finalPrice}
         ,#{price},#{costPrice},#{cover},#{id})
    </insert>

    <update id="upStockBalance" >
        update t_product set stock_balance=stock_balance+#{num} where id=#{productId}
    </update>


    <update id="closeProduct" >
    update t_order SET t_order.`status`='CLOSED_CONFIRMED'
    where  id=#{id}
    </update>

    <update id="cancelcloseProduct" >
    update t_order SET t_order.`status`='DELIVERED_CONFIRM_PENDING',t_order.settlement_status=0
    where  id=#{id}
    </update>




</mapper>