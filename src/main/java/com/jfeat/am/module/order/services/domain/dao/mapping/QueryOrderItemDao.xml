<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jfeat.am.module.order.services.domain.dao.QueryOrderItemDao">
    <sql id="Base_Column_List">
           t_order_item.id, t_order_item.order_id AS orderId, t_order_item.product_id AS productId,
           t_order_item.product_name AS productName, t_order_item.quantity, t_order_item.price,
            t_order_item.final_price AS finalPrice, t_order_item.status, t_order_item.cost_price AS costPrice,
             t_order_item.cover, t_order_item.partner_level_zone AS partnerLevelZone,
              t_order_item.product_specification_name AS productSpecificationName,
              t_order_item.product_specification_id AS productSpecificationId, t_order_item.weight,
               t_order_item.bulk, t_order_item.barcode, t_order_item.store_location AS storeLocation,
               t_order_item.marketing, t_order_item.marketing_id AS marketingId, t_order_item.marketing_description AS marketingDescription,
                t_order_item.sku_id AS skuId, t_order_item.warehouse_id AS warehouseId
    </sql>


    <select id="findOrderItemPage" parameterType="OrderItemRecord">
        SELECT
        <include refid="Base_Column_List"/>
        FROM t_order_item
        WHERE 1=1
        <if test="record.id != null and record.id>0 ">
            AND t_order_item.id LIKE CONCAT('%',#{record.id},'%')
        </if>
        <if test="record.orderId != null and record.orderId>0 ">
            AND t_order_item.order_id LIKE CONCAT('%',#{record.orderId},'%')
        </if>
        <if test="record.productId != null and record.productId>0 ">
            AND t_order_item.product_id LIKE CONCAT('%',#{record.productId},'%')
        </if>
        <if test="record.productName != null and record.productName!= ''">
            AND t_order_item.product_name LIKE CONCAT('%',#{record.productName},'%')
        </if>
        <if test="record.quantity != null and record.quantity>0 ">
            AND t_order_item.quantity LIKE CONCAT('%',#{record.quantity},'%')
        </if>
        <if test="record.price != null and record.price>0 ">
            AND t_order_item.price LIKE CONCAT('%',#{record.price},'%')
        </if>
        <if test="record.finalPrice != null and record.finalPrice>0 ">
            AND t_order_item.final_price LIKE CONCAT('%',#{record.finalPrice},'%')
        </if>
        <if test="record.status != null and record.status!= ''">
            AND t_order_item.status LIKE CONCAT('%',#{record.status},'%')
        </if>
        <if test="record.costPrice != null and record.costPrice>0 ">
            AND t_order_item.cost_price LIKE CONCAT('%',#{record.costPrice},'%')
        </if>
        <if test="record.cover != null and record.cover!= ''">
            AND t_order_item.cover LIKE CONCAT('%',#{record.cover},'%')
        </if>
        <if test="record.partnerLevelZone != null and record.partnerLevelZone>0 ">
            AND t_order_item.partner_level_zone LIKE CONCAT('%',#{record.partnerLevelZone},'%')
        </if>
        <if test="record.productSpecificationName != null and record.productSpecificationName!= ''">
            AND t_order_item.product_specification_name LIKE CONCAT('%',#{record.productSpecificationName},'%')
        </if>
        <if test="record.productSpecificationId != null and record.productSpecificationId>0 ">
            AND t_order_item.product_specification_id LIKE CONCAT('%',#{record.productSpecificationId},'%')
        </if>
        <if test="record.weight != null and record.weight>0 ">
            AND t_order_item.weight LIKE CONCAT('%',#{record.weight},'%')
        </if>
        <if test="record.bulk != null and record.bulk>0 ">
            AND t_order_item.bulk LIKE CONCAT('%',#{record.bulk},'%')
        </if>
        <if test="record.barcode != null and record.barcode!= ''">
            AND t_order_item.barcode LIKE CONCAT('%',#{record.barcode},'%')
        </if>
        <if test="record.storeLocation != null and record.storeLocation!= ''">
            AND t_order_item.store_location LIKE CONCAT('%',#{record.storeLocation},'%')
        </if>
        <if test="record.marketing != null and record.marketing!= ''">
            AND t_order_item.marketing LIKE CONCAT('%',#{record.marketing},'%')
        </if>
        <if test="record.marketingId != null and record.marketingId>0 ">
            AND t_order_item.marketing_id LIKE CONCAT('%',#{record.marketingId},'%')
        </if>
        <if test="record.marketingDescription != null and record.marketingDescription!= ''">
            AND t_order_item.marketing_description LIKE CONCAT('%',#{record.marketingDescription},'%')
        </if>
        <if test="record.skuId != null and record.skuId!= ''">
            AND t_order_item.sku_id LIKE CONCAT('%',#{record.skuId},'%')
        </if>
        <if test="record.warehouseId != null and record.warehouseId!= ''">
            AND t_order_item.warehouse_id LIKE CONCAT('%',#{record.warehouseId},'%')
        </if>
        <if test="startTime != null">
            <![CDATA[AND t_order_item.start_time >= DATE(#{startTime})]]>
        </if>
        <if test="endTime != null">
            <![CDATA[AND t_order_item.end_time <= DATE(#{endTime)]]>
        </if>
        <!--
    <if test="search != null and search != ''">
        OR t_order_item.name LIKE CONCAT('%',#{search},'%')
    </if>
    -->
    </select>

    <select id="inventory" resultType="OrderItemRecord">
        select
            t_order_item.id, t_order_item.order_id AS orderId, t_order_item.product_id AS productId,
            t_order_item.product_name AS productName,  t_order_item.price,
            t_order_item.final_price AS finalPrice, t_order_item.status, t_order_item.cost_price AS costPrice,
            t_order_item.cover, t_order_item.partner_level_zone AS partnerLevelZone,
            t_order_item.product_specification_name AS productSpecificationName,
            t_order_item.product_specification_id AS productSpecificationId, t_order_item.weight,
            t_order_item.bulk, t_order_item.barcode, t_order_item.store_location AS storeLocation,
            t_order_item.marketing, t_order_item.marketing_id AS marketingId, t_order_item.marketing_description AS marketingDescription,
            t_order_item.sku_id AS skuId, t_order_item.warehouse_id AS warehouseId
        ,sum(t_order_item.quantity) as quantity
        ,t_product.sku_code as skuCode
        FROM
        t_order_item
        LEFT JOIN t_order ON t_order.id = t_order_item.order_id
        left join t_product on t_product.id = t_order_item.product_id
        WHERE
        t_order.org_id = #{orgId}
        and t_order.`status` = 'CONFIRMED_DELIVER_PENDING'
        <if test="search != null and search != ''">
            and t_order_item.product_name LIKE CONCAT('%',#{search},'%')
        </if>
        group by t_order_item.product_id
    </select>

    <select id="listOrderItem" resultType="OrderItemRecord" parameterType="OrderItemRecord">
    SELECT
        <include refid="Base_Column_List"></include>
    FROM
        `t_order_item`
    <where>
        <if test="orderItemRecord.id != null and orderItemRecord.id>0 ">
            AND `t_order_item`.id = #{orderItemRecord.id}
        </if>
        <if test="orderItemRecord.orderId != null and orderItemRecord.orderId>0 ">
            AND `t_order_item`.order_id = #{orderItemRecord.orderId}
        </if>
        <if test="orderItemRecord.productId != null and orderItemRecord.productId>0 ">
            AND `t_order_item`.product_id = #{orderItemRecord.productId}
        </if>
        <if test="orderItemRecord.productName != null and orderItemRecord.productName!= ''">
            AND `t_order_item`.product_name = #{orderItemRecord.productName}
        </if>
        <if test="orderItemRecord.quantity != null and orderItemRecord.quantity>0 ">
            AND `t_order_item`.quantity = #{orderItemRecord.quantity}
        </if>
        <if test="orderItemRecord.price != null and orderItemRecord.price>0 ">
            AND `t_order_item`.price = #{orderItemRecord.price}
        </if>
        <if test="orderItemRecord.finalPrice != null and orderItemRecord.finalPrice>0 ">
            AND `t_order_item`.final_price = #{orderItemRecord.finalPrice}
        </if>
        <if test="orderItemRecord.status != null and orderItemRecord.status!= ''">
            AND `t_order_item`.status = #{orderItemRecord.status}
        </if>
        <if test="orderItemRecord.costPrice != null and orderItemRecord.costPrice>0 ">
            AND `t_order_item`.cost_price = #{orderItemRecord.costPrice}
        </if>
        <if test="orderItemRecord.cover != null and orderItemRecord.cover!= ''">
            AND `t_order_item`.cover = #{orderItemRecord.cover}
        </if>
        <if test="orderItemRecord.partnerLevelZone != null and orderItemRecord.partnerLevelZone>0 ">
            AND `t_order_item`.partner_level_zone = #{orderItemRecord.partnerLevelZone}
        </if>
        <if test="orderItemRecord.productSpecificationName != null and orderItemRecord.productSpecificationName!= ''">
            AND `t_order_item`.product_specification_name = #{orderItemRecord.productSpecificationName}
        </if>
        <if test="orderItemRecord.productSpecificationId != null and orderItemRecord.productSpecificationId>0 ">
            AND `t_order_item`.product_specification_id = #{orderItemRecord.productSpecificationId}
        </if>
        <if test="orderItemRecord.weight != null and orderItemRecord.weight>0 ">
            AND `t_order_item`.weight = #{orderItemRecord.weight}
        </if>
        <if test="orderItemRecord.bulk != null and orderItemRecord.bulk>0 ">
            AND `t_order_item`.bulk = #{orderItemRecord.bulk}
        </if>
        <if test="orderItemRecord.barcode != null and orderItemRecord.barcode!= ''">
            AND `t_order_item`.barcode = #{orderItemRecord.barcode}
        </if>
        <if test="orderItemRecord.storeLocation != null and orderItemRecord.storeLocation!= ''">
            AND `t_order_item`.store_location = #{orderItemRecord.storeLocation}
        </if>
        <if test="orderItemRecord.marketing != null and orderItemRecord.marketing!= ''">
            AND `t_order_item`.marketing = #{orderItemRecord.marketing}
        </if>
        <if test="orderItemRecord.marketingId != null and orderItemRecord.marketingId>0 ">
            AND `t_order_item`.marketing_id = #{orderItemRecord.marketingId}
        </if>
        <if test="orderItemRecord.marketingDescription != null and orderItemRecord.marketingDescription!= ''">
            AND `t_order_item`.marketing_description = #{orderItemRecord.marketingDescription}
        </if>
        <if test="orderItemRecord.skuId != null and orderItemRecord.skuId!= ''">
            AND `t_order_item`.sku_id = #{orderItemRecord.skuId}
        </if>
        <if test="orderItemRecord.warehouseId != null and orderItemRecord.warehouseId!= ''">
            AND `t_order_item`.warehouse_id = #{orderItemRecord.warehouseId}
        </if>
    </where>
    </select>

    <!--  查询用户表信息  -->
    <select id="getUser" resultType="HashMap">
        SELECT
            `id`,`name`,`avatar`,`phone`,`real_name`
        FROM
            `t_end_user`
        WHERE
            id = #{userId}
    </select>

    <sql id="orderItem_and_oder_and_user_column">
        t_order_item.id,
        t_order_item.product_id AS productId,
        t_order_item.product_name AS productName,
        t_order_item.quantity,
        t_order_item.price,
        t_order_item.final_price AS finalPrice,
        t_order_item.cost_price AS costPrice,

        t_order.user_id AS userId,
        t_order.order_number AS orderNumber,
        t_order.created_date AS createdDate
    </sql>
    <resultMap id="listOrderItemMap" type="OrderItemRecord">
        <id column="id" property="id"/>
        <result column="productId" property="productId"/>
        <result column="productName" property="productName"/>
        <result column="quantity" property="quantity"/>
        <result column="price" property="price"/>
        <result column="finalPrice" property="finalPrice"/>
        <result column="costPrice" property="costPrice"/>
        <result column="orderNumber" property="orderNumber"/>
        <association property="user" column="userId" select="com.jfeat.am.module.order.services.domain.dao.QueryOrderItemDao.getUser"/>
    </resultMap>
    <!--  分页——获取所有订单  sql过滤了如果这个订单的用户不存在，没有name，没有phone都不返回-->
    <select id="getOrderItemPage" resultMap="listOrderItemMap">
        SELECT
            <include refid="orderItem_and_oder_and_user_column" />
        FROM
            t_order_item
        LEFT JOIN t_order ON t_order_item.order_id = t_order.id
        WHERE
            t_order.state = 1
          AND
            EXISTS(SELECT
                       *
                   FROM
                       t_end_user
                   WHERE
                       t_end_user.id = t_order.user_id AND t_end_user.name IS NOT NULL AND t_end_user.phone IS NOT NULL
                   )
        ORDER BY t_order.created_date DESC
    </select>
    <!--  分页——获取指定用户的商品订单  -->
    <select id="getOrderItemByUserIdPage" resultMap="listOrderItemMap">
        SELECT
            <include refid="orderItem_and_oder_and_user_column" />
        FROM
            t_order_item
        LEFT JOIN t_order ON t_order_item.order_id = t_order.id
        WHERE
            t_order.user_id = #{userId} AND t_order.state = 1
        ORDER BY t_order.created_date DESC
    </select>

</mapper>