<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jfeat.am.module.frontproduct.services.domain.dao.QueryFrontProductDao">
    <sql id="Base_Column_List">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        t_product.id, t_product.category_id AS categoryId, t_product.brand_id AS brandId, t_product.name, t_product.short_name AS shortName, t_product.cover, t_product.stock_balance AS stockBalance, t_product.sales, t_product.status, t_product.created_date AS createdDate, t_product.last_modified_date AS lastModifiedDate, t_product.unit, t_product.price, t_product.cost_price AS costPrice, t_product.suggested_price AS suggestedPrice, t_product.promoted, t_product.freight, t_product.free_shipping AS freeShipping, t_product.sort_order AS sortOrder, t_product.partner_level_zone AS partnerLevelZone, t_product.view_count AS viewCount, t_product.fare_id AS fareId, t_product.barcode, t_product.store_location AS storeLocation, t_product.weight, t_product.bulk, t_product.sku_id AS skuId, t_product.sku_name AS skuName, t_product.sku_code AS skuCode, t_product.bar_code AS barCode, t_product.mid, t_product.allow_coupon AS allowCoupon, t_product.credit, t_product.is_virtual AS isVirtual, t_product.required_participate_exam AS requiredParticipateExam
    </sql>


    <select id="findProductModelById" resultType="FrontProductModel">
        SELECT
		t_product.id,
		t_product.distribution_price AS distributionPrice,
		t_product.category_id AS categoryId,
		t_product.brand_id AS brandId,
		t_product. NAME,
		t_product.short_name AS shortName,
		t_product.cover,
		t_product.stock_balance AS stockBalance,
		t_product.sales,
		t_product. STATUS,
		t_product.created_date AS createdDate,
		t_product.last_modified_date AS lastModifiedDate,
		t_product.unit,
		t_product.price,
		t_product.cost_price AS costPrice,
		t_product.suggested_price AS suggestedPrice,
		t_product.promoted,
		t_product.freight,
		t_product.free_shipping AS freeShipping,
		t_product.sort_order AS sortOrder,
		t_product.partner_level_zone AS partnerLevelZone,
		t_product.view_count AS viewCount,
		t_product.fare_id AS fareId,
		t_product.store_location AS storeLocation,
		t_product.weight,
		t_product.bulk,
		t_product.sku_id AS skuId,
		t_product.sku_name AS skuName,
		t_product.sku_code AS skuCode,
        t_product.banner,
		t_product.barcode AS barcode,

		t_product.mid,
		t_product.allow_coupon AS allowCoupon,
		t_product.credit,
		t_product.is_virtual AS isVirtual,
		t_product.required_participate_exam AS requiredParticipateExam,

		t_fare_template. name AS fareName,
	    t_product_brand. NAME AS brandName,
	    category. NAME AS categoryName
	FROM
		t_product
	  LEFT JOIN t_product_brand ON t_product.brand_id = t_product_brand.id
      LEFT JOIN t_product_category category ON category.id = t_product.category_id
	  LEFT JOIN t_fare_template ON t_product.fare_id = t_fare_template.id

	WHERE
		t_product.id =#{id}
    </select>


    <sql id="QueryOwnedOrgIds">
        SELECT children.id FROM t_sys_org, t_sys_org as children WHERE t_sys_org.left_num &lt;= children.left_num AND
            t_sys_org.right_num >= children.left_num and t_sys_org.id=#{record.orgId} order by t_sys_org.node_level ASC
    </sql>


    <select id="findProductPage" resultType="FrontProductRecord" parameterType="FrontProductRecord">
        SELECT
        t_product.id,
        t_product.distribution_price AS distributionPrice,
        t_product.category_id AS categoryId,
        t_product.brand_id AS brandId,
        t_product. NAME,
        t_product.short_name AS shortName,
        t_product.cover,
        t_product.stock_balance AS stockBalance,
        t_product.sales,
        t_product. STATUS,
        t_product.created_date AS createdDate,
        t_product.last_modified_date AS lastModifiedDate,
        t_product.unit,
        t_product.price,
        t_product.cost_price AS costPrice,
        t_product.suggested_price AS suggestedPrice,
        t_product.promoted,
        t_product.freight,
        t_product.free_shipping AS freeShipping,
        t_product.sort_order AS sortOrder,
        t_product.partner_level_zone AS partnerLevelZone,
        t_product.view_count AS viewCount,
        t_product.fare_id AS fareId,
        t_product.store_location AS storeLocation,
        t_product.weight,
        t_product.bulk,
        t_product.sku_id AS skuId,
        t_product.sku_name AS skuName,
        t_product.sku_code AS skuCode,

        t_product.barcode AS barcode,
        t_product.mid,
        t_product.allow_coupon AS allowCoupon,
        t_product.credit,
        t_product.is_virtual AS isVirtual,
        t_product.required_participate_exam AS requiredParticipateExam,
        t_product.banner,
        t_product_brand.name AS brandName,
        category.name AS categoryName,
        t_supplier.name as supplierName
        FROM  t_product
        LEFT JOIN t_product_brand ON t_product.brand_id=t_product_brand.id
        LEFT JOIN t_product_category category ON category.id = t_product.category_id
        LEFT JOIN t_supplier on t_supplier.org_id = t_product.org_id
        <if test="record.orgId > 0">
            ,(<include refid="QueryOwnedOrgIds"></include>) AS ownedOrgIds
        </if>

        WHERE 1=1
        <if test="record.orgId > 0">
            AND t_product.org_id = ownedOrgIds.id
        </if>

        <if test = "supplierId != null">
            AND t_supplier.id = #{supplierId}
        </if>

        <if test="supplierName != null and supplierName!= ''">
            AND t_supplier.name LIKE CONCAT('%',#{supplierName},'%')
        </if>

        <if test="record.categoryName != null and record.categoryName!= ''">
            AND category.name LIKE CONCAT('%',#{record.categoryName},'%')
        </if>

        <if test="record.id != null and record.id>0 ">
            AND t_product.id LIKE CONCAT('%',#{record.id},'%')
        </if>
        <if test="record.categoryId != null and record.categoryId>0 ">
            AND t_product.category_id LIKE CONCAT('%',#{record.categoryId},'%')
        </if>
        <if test="record.brandId != null and record.brandId>0 ">
            AND t_product.brand_id LIKE CONCAT('%',#{record.brandId},'%')
        </if>
        <if test="record.brandName != null and record.brandName!= ''">
            AND t_product_brand.name LIKE CONCAT('%',#{record.brandName},'%')
        </if>
        <if test="record.name != null and record.name!= ''">
            AND t_product.name LIKE CONCAT('%',#{record.name},'%')
        </if>
        <if test="record.shortName != null and record.shortName!= ''">
            AND t_product.short_name LIKE CONCAT('%',#{record.shortName},'%')
        </if>
        <if test="record.cover != null and record.cover!= ''">
            AND t_product.cover LIKE CONCAT('%',#{record.cover},'%')
        </if>
        <if test="record.stockBalance != null and record.stockBalance>0 ">
            AND t_product.stock_balance LIKE CONCAT('%',#{record.stockBalance},'%')
        </if>
        <if test="record.sales != null and record.sales>0 ">
            AND t_product.sales LIKE CONCAT('%',#{record.sales},'%')
        </if>
        <if test="record.status != null and record.status!= ''">
            AND t_product.status LIKE CONCAT('%',#{record.status},'%')
        </if>
        <if test="record.createdDate != null and record.createdDate>0 ">
            AND t_product.created_date LIKE CONCAT('%',#{record.createdDate},'%')
        </if>
        <if test="record.lastModifiedDate != null and record.lastModifiedDate>0 ">
            AND t_product.last_modified_date LIKE CONCAT('%',#{record.lastModifiedDate},'%')
        </if>
        <if test="record.unit != null and record.unit!= ''">
            AND t_product.unit LIKE CONCAT('%',#{record.unit},'%')
        </if>
        <if test="record.price != null and record.price>0 ">
            AND t_product.price LIKE CONCAT('%',#{record.price},'%')
        </if>
        <if test="record.costPrice != null and record.costPrice>0 ">
            AND t_product.cost_price LIKE CONCAT('%',#{record.costPrice},'%')
        </if>
        <if test="record.suggestedPrice != null and record.suggestedPrice>0 ">
            AND t_product.suggested_price LIKE CONCAT('%',#{record.suggestedPrice},'%')
        </if>
        <if test="record.promoted != null and record.promoted>0 ">
            AND t_product.promoted LIKE CONCAT('%',#{record.promoted},'%')
        </if>
        <if test="record.freight != null and record.freight>0 ">
            AND t_product.freight LIKE CONCAT('%',#{record.freight},'%')
        </if>
        <if test="record.freeShipping != null and record.freeShipping>0 ">
            AND t_product.free_shipping LIKE CONCAT('%',#{record.freeShipping},'%')
        </if>
        <if test="record.sortOrder != null and record.sortOrder>0 ">
            AND t_product.sort_order LIKE CONCAT('%',#{record.sortOrder},'%')
        </if>
        <if test="record.partnerLevelZone != null and record.partnerLevelZone>0 ">
            AND t_product.partner_level_zone LIKE CONCAT('%',#{record.partnerLevelZone},'%')
        </if>
        <if test="record.viewCount != null and record.viewCount>0 ">
            AND t_product.view_count LIKE CONCAT('%',#{record.viewCount},'%')
        </if>
        <if test="record.fareId != null and record.fareId>0 ">
            AND t_product.fare_id LIKE CONCAT('%',#{record.fareId},'%')
        </if>

        <if test="record.storeLocation != null and record.storeLocation!= ''">
            AND t_product.store_location LIKE CONCAT('%',#{record.storeLocation},'%')
        </if>
        <if test="record.weight != null and record.weight>0 ">
            AND t_product.weight LIKE CONCAT('%',#{record.weight},'%')
        </if>
        <if test="record.bulk != null and record.bulk>0 ">
            AND t_product.bulk LIKE CONCAT('%',#{record.bulk},'%')
        </if>
        <if test="record.skuId != null and record.skuId!= ''">
            AND t_product.sku_id LIKE CONCAT('%',#{record.skuId},'%')
        </if>
        <if test="record.skuName != null and record.skuName!= ''">
            AND t_product.sku_name LIKE CONCAT('%',#{record.skuName},'%')
        </if>
        <if test="record.skuCode != null and record.skuCode!= ''">
            AND t_product.sku_code LIKE CONCAT('%',#{record.skuCode},'%')
        </if>
        <if test="record.barcode != null and record.barcode!= ''">
            AND t_product.barcode LIKE CONCAT('%',#{record.barcode},'%')
        </if>
        <if test="record.mid != null and record.mid>0 ">
            AND t_product.mid LIKE CONCAT('%',#{record.mid},'%')
        </if>
        <if test="record.allowCoupon != null and record.allowCoupon>0 ">
            AND t_product.allow_coupon LIKE CONCAT('%',#{record.allowCoupon},'%')
        </if>
        <if test="record.credit != null and record.credit>0 ">
            AND t_product.credit LIKE CONCAT('%',#{record.credit},'%')
        </if>
        <if test="record.isVirtual != null and record.isVirtual>0 ">
            AND t_product.is_virtual LIKE CONCAT('%',#{record.isVirtual},'%')
        </if>
        <if test="record.requiredParticipateExam != null and record.requiredParticipateExam>0 ">
            AND t_product.required_participate_exam LIKE CONCAT('%',#{record.requiredParticipateExam},'%')
        </if>

        <if test="startTime != null">
            <![CDATA[AND t_product.start_time >= DATE(#{startTime})]]>
        </if>
        <if test="endTime != null">
            <![CDATA[AND t_product.end_time <= DATE(#{endTime)]]>
        </if>
    <if test="search != null and search != ''">
        AND
        (
        t_product.name LIKE CONCAT('%',#{search},'%')
        OR
        t_product.barcode LIKE CONCAT('%',#{search},'%')
        OR
        category.name LIKE CONCAT('%',#{search},'%')
        OR
        t_product_brand.name LIKE CONCAT('%',#{search},'%')
        )
    </if>
        order by t_product.sort_order  desc,t_product.status desc
    </select>
</mapper>